<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quên Mật Khẩu</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { primary: '#DC2626' }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

    <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md relative overflow-hidden">
        <div class="h-2 bg-primary absolute top-0 left-0 w-full"></div>

        <div class="text-center mb-8">
            <h1 class="text-2xl font-bold text-gray-800">Khôi Phục Mật Khẩu</h1>
            <p class="text-gray-500 text-sm mt-2">Đừng lo, chúng tôi sẽ giúp bạn lấy lại tài khoản.</p>
        </div>

        <div id="step-1" class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Email đăng ký</label>
                <input type="email" id="email-input" placeholder="nhap@email.cua.ban" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500 outline-none transition">
            </div>
            <button onclick="sendOTP()" class="w-full bg-primary hover:bg-red-700 text-white font-bold py-3 rounded-lg transition shadow-lg shadow-red-200">
                <i class="fas fa-paper-plane mr-2"></i> Gửi Mã OTP
            </button>
        </div>

        <div id="step-2" class="space-y-4 hidden">
            <div class="text-center bg-blue-50 p-3 rounded-lg border border-blue-100 mb-4">
                <p class="text-sm text-blue-800">Mã OTP đã gửi đến: <b id="display-email">...</b></p>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Nhập mã xác nhận (6 số)</label>
                <input type="text" id="otp-input" maxlength="6" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 text-center font-bold text-xl tracking-widest outline-none">
            </div>
            <button onclick="verifyOTP()" class="w-full bg-primary hover:bg-red-700 text-white font-bold py-3 rounded-lg transition">
                Xác Thực
            </button>
        </div>

        <div id="step-3" class="space-y-4 hidden">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Mật khẩu mới</label>
                <input type="password" id="new-pass" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 outline-none">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Nhập lại mật khẩu</label>
                <input type="password" id="confirm-pass" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 outline-none">
            </div>
            <button onclick="resetPassword()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg transition shadow-lg shadow-green-200">
                Đổi Mật Khẩu
            </button>
        </div>

        <div class="mt-6 text-center border-t pt-4">
            <a href="login.html" class="text-sm text-gray-500 hover:text-primary font-medium">Quay lại đăng nhập</a>
        </div>
    </div>

    <script>
        // ================= CẤU HÌNH EMAILJS =================
        // Bạn PHẢI thay 3 dòng này bằng thông tin của bạn
        const SERVICE_ID = "YOUR_SERVICE_ID";   // Ví dụ: service_x8d...
        const TEMPLATE_ID = "YOUR_TEMPLATE_ID"; // Ví dụ: template_k9s...
        const PUBLIC_KEY = "YOUR_PUBLIC_KEY";   // Ví dụ: H7sDn9...

        (function(){
            emailjs.init(PUBLIC_KEY);
        })();
        // ====================================================

        let generatedOTP = null;
        let userEmail = '';

        // Tạo dữ liệu giả nếu chưa có (Để test)
        if (!localStorage.getItem('users')) {
            const sampleUsers = [
                { email: 'test@gmail.com', password: '123', name: 'User Test' }
            ];
            localStorage.setItem('users', JSON.stringify(sampleUsers));
            console.log("Đã tạo user mẫu: test@gmail.com / 123");
        }

        // HÀM 1: GỬI OTP
        function sendOTP() {
            const email = document.getElementById('email-input').value.trim();
            const users = JSON.parse(localStorage.getItem('users')) || [];
            
            // 1. Kiểm tra email có tồn tại trong LocalStorage không
            const userExists = users.find(u => u.email === email);

            if (!userExists) {
                Swal.fire('Lỗi', 'Email này chưa được đăng ký trong hệ thống!', 'error');
                return;
            }

            // 2. Tạo mã OTP ngẫu nhiên 6 số
            generatedOTP = Math.floor(100000 + Math.random() * 900000);
            userEmail = email;

            // Hiển thị loading
            Swal.fire({
                title: 'Đang gửi mail...',
                text: 'Vui lòng đợi trong giây lát',
                allowOutsideClick: false,
                didOpen: () => { Swal.showLoading() }
            });

            // 3. Gửi mail qua EmailJS
            const templateParams = {
                to_email: email,       // Biến này phải khớp với Template EmailJS
                to_name: userExists.name,
                otp_code: generatedOTP // Biến này phải có trong Template {{otp_code}}
            };

            emailjs.send(SERVICE_ID, TEMPLATE_ID, templateParams)
                .then(function() {
                    Swal.fire('Thành công', 'Mã OTP đã được gửi vào email của bạn!', 'success');
                    // Chuyển sang bước 2
                    document.getElementById('step-1').classList.add('hidden');
                    document.getElementById('step-2').classList.remove('hidden');
                    document.getElementById('display-email').innerText = email;
                }, function(error) {
                    console.error('FAILED...', error);
                    Swal.fire('Lỗi Server', 'Không thể gửi mail lúc này. Vui lòng kiểm tra lại Key EmailJS.', 'error');
                });
        }

        // HÀM 2: XÁC THỰC OTP
        function verifyOTP() {
            const inputOTP = document.getElementById('otp-input').value;
            if (inputOTP == generatedOTP) {
                Swal.fire('Chính xác', 'Mời bạn nhập mật khẩu mới', 'success');
                document.getElementById('step-2').classList.add('hidden');
                document.getElementById('step-3').classList.remove('hidden');
            } else {
                Swal.fire('Sai mã OTP', 'Vui lòng kiểm tra lại email', 'error');
            }
        }

        // HÀM 3: LƯU MẬT KHẨU MỚI VÀO LOCALSTORAGE
        function resetPassword() {
            const newPass = document.getElementById('new-pass').value;
            const confirmPass = document.getElementById('confirm-pass').value;

            if (newPass.length < 6) {
                Swal.fire('Yếu', 'Mật khẩu phải từ 6 ký tự trở lên', 'warning');
                return;
            }
            if (newPass !== confirmPass) {
                Swal.fire('Lỗi', 'Hai mật khẩu không khớp nhau', 'error');
                return;
            }

            // Cập nhật LocalStorage
            let users = JSON.parse(localStorage.getItem('users')) || [];
            const userIndex = users.findIndex(u => u.email === userEmail);
            
            if (userIndex !== -1) {
                users[userIndex].password = newPass; // Lưu pass mới
                localStorage.setItem('users', JSON.stringify(users)); // Update vào Storage

                Swal.fire({
                    title: 'Thành công!',
                    text: 'Mật khẩu đã được đổi. Đang chuyển về trang đăng nhập...',
                    icon: 'success',
                    timer: 2000,
                    showConfirmButton: false
                }).then(() => {
                    window.location.href = 'login.html';
                });
            }
        }
    </script>
</body>
</html>